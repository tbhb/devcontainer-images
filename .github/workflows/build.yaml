---
name: Build and push images

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      image:
        description: 'Image to build (leave empty for all)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  detect-variants:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Detect image variants to build
        id: detect
        run: |
          matrix='{"include":[]}'

          # Find all image directories
          if [[ -n "${{ inputs.image }}" ]]; then
            images="${{ inputs.image }}"
          else
            images=$(find src -maxdepth 1 -mindepth 1 -type d -printf '%f\n')
          fi

          for image in $images; do
            manifest="src/${image}/manifest.json"
            if [[ -f "$manifest" ]]; then
              # Derive version arg name from image name (e.g., python -> PYTHON_VERSION, go -> GO_VERSION)
              version_arg_name=$(echo "${image}_VERSION" | tr '[:lower:]' '[:upper:]')

              # Read variants from manifest
              variants=$(jq -r '.variants | keys[]' "$manifest")
              for variant in $variants; do
                # Get tags as JSON array string for proper parsing later
                tags=$(jq -c ".variants[\"${variant}\"].tags" "$manifest")
                archs=$(jq -r ".variants[\"${variant}\"].architectures | join(\",\")" "$manifest")

                # shellcheck disable=SC2016
                matrix=$(echo "$matrix" | jq \
                  --arg image "$image" \
                  --arg variant "$variant" \
                  --arg version_arg_name "$version_arg_name" \
                  --argjson tags "$tags" \
                  --arg archs "$archs" \
                  '.include += [{
                    "image": $image,
                    "variant": $variant,
                    "version_arg_name": $version_arg_name,
                    "tags": $tags,
                    "architectures": $archs
                  }]')
              done
            fi
          done

          # Compact JSON to single line for GITHUB_OUTPUT
          matrix_compact=$(echo "$matrix" | jq -c .)
          echo "matrix=${matrix_compact}" >> "$GITHUB_OUTPUT"
          echo "Matrix: ${matrix_compact}"

  build:
    needs: detect-variants
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.detect-variants.outputs.matrix).include[0] != null }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix: ${{ fromJson(needs.detect-variants.outputs.matrix) }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Update devcontainer.json with variant
        run: |
          # Update the version build arg to use full variant (e.g., 3.14-trixie, 1.25-bookworm)
          jq --arg version "${{ matrix.variant }}" \
             --arg arg_name "${{ matrix.version_arg_name }}" \
            '.build.args[$arg_name] = $version' \
            "src/${{ matrix.image }}/.devcontainer/devcontainer.json" > tmp.json
          mv tmp.json "src/${{ matrix.image }}/.devcontainer/devcontainer.json"

      - name: Generate comma-separated tags
        id: tags
        run: |
          # Convert JSON array to comma-separated string
          tags='${{ toJson(matrix.tags) }}'
          tags_csv=$(echo "$tags" | jq -r 'join(",")')
          echo "tags_csv=${tags_csv}" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        uses: devcontainers/ci@8bf61b26e9c3a98f69cb6ce2f88d24ff59b785c6 # v0.3
        with:
          imageName: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}
          imageTag: ${{ steps.tags.outputs.tags_csv }}
          subFolder: src/${{ matrix.image }}
          platform: ${{ matrix.architectures }}
          push: always
